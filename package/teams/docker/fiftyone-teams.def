Bootstrap: docker
From: ubuntu:20.04

%environment
    export FIFTYONE_MEDIA_CACHE_SIZE_BYTES=-1
    export FIFTYONE_MEDIA_CACHE_APP_IMAGES=false
    export FIFTYONE_DATABASE_ADMIN=true
    export FIFTYONE_DATABASE_NAME=fiftyone
    export FIFTYONE_DEFAULT_APP_PORT=5151
    export FIFTYONE_DEFAULT_APP_ADDRESS='0.0.0.0'

%post
    PYTHON_VERSION=3.9
    apt -y update \
    && apt -y --no-install-recommends install software-properties-common \
    && add-apt-repository -y ppa:deadsnakes/ppa \
    && apt -y update \
    && apt -y upgrade \
    && apt -y --no-install-recommends install tzdata \
    && TZ=Etc/UTC \
    && apt -y --no-install-recommends install \
        build-essential \
        ca-certificates \
        cmake \
        cmake-data \
        pkg-config \
        libcurl4 \
        libsm6 \
        libxext6 \
        libssl-dev \
        libffi-dev \
        libxml2-dev \
        libxslt1-dev \
        zlib1g-dev \
        unzip \
        curl \
        wget \
        python${PYTHON_VERSION} \
        python${PYTHON_VERSION}-dev \
        python${PYTHON_VERSION}-distutils \
        ffmpeg \
    && ln -s /usr/bin/python${PYTHON_VERSION} /usr/local/bin/python \
    && ln -s /usr/local/lib/python${PYTHON_VERSION} /usr/local/lib/python \
    && curl https://bootstrap.pypa.io/get-pip.py | python \
    && rm -rf /var/lib/apt/lists/* \
    && pip --no-cache-dir install --upgrade pip setuptools wheel ipython \
    && pip --no-cache-dir install --index-url https://${TOKEN}@pypi.fiftyone.ai fiftyone-teams-app

%runscript
    hypercorn fiftyone.teams.app:app --bind ${FIFTYONE_DEFAULT_APP_ADDRESS}:${FIFTYONE_DEFAULT_APP_PORT}
