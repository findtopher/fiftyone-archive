# Dockerfile for building an image with a FiftyOne Team App release atop a
# alpine-based distribution.
#
# REQUIRED BUILD ARGs::
#
#   TOKEN: Your Teams client install token
#
# OPTIONAL BUILD ARGs::
#
#   BASE_IMAGE (alpine:3.16): The Debian-based image to build from
#   ROOT_DIR (/fiftyone): The name of the directory within the container that
#       should be mounted when running
#
# REQUIRED RUNTIME ENV VARS::
#
#   FIFTYONE_DATABASE_URI: your MongoDB database URI
#   FIFTYONE_TEAMS_CLIENT_ID: your application client ID
#   FIFTYONE_TEAMS_ORGANIZATION: your organization's authentication ID
#   (your cloud storage credentials)
#
# Example usage::
#
#   # Build
#   docker build \
#       --build-arg TOKEN=${TOKEN} \
#       -t voxel51/fiftyone-teams-app .
#
#   # Run
#   SHARED_DIR=/data # if necessary
#   docker run \
#       -e FIFTYONE_DATABASE_URI=mongodb://... \
#       -e FIFTYONE_TEAMS_CLIENT_ID=... \
#       -e FIFTYONE_TEAMS_ORGANIZATION=... \
#       -e AWS_CONFIG_FILE=/fiftyone/aws-credentials.ini \
#       -v ${SHARED_DIR}:/fiftyone \
#       -p 5151:5151 \
#       -it voxel51/fiftyone-teams-app
#
# Copyright 2017-2023, Voxel51, Inc.
# voxel51.com
#

# The base image to build from; must be Debian-based (eg Ubuntu)
ARG BASE_IMAGE=alpine:3.16
FROM $BASE_IMAGE

#
# Install system packages
#

RUN apk update && apk upgrade --available && sync \
    && apk add --no-cache \
    ffmpeg \
    py3-matplotlib \
    py3-numpy \
    py3-pip \
    py3-scipy \
    py3-setuptools \
    py3-wheel \
    python3 \
    python3-dev \
    && rm -rf /var/cache/apk

#
# Install FiftyOne Teams
#

# Your install token
ARG TOKEN

# The Teams App version to install, or "latest"
ARG TEAMS_APP_VERSION=0.1.7

RUN if [ "${TEAMS_APP_VERSION}" = "latest" ]; then \
        pip --no-cache-dir install --index-url https://${TOKEN}@pypi.fiftyone.ai fiftyone-teams-app; \
    else \
        pip --no-cache-dir install --index-url https://${TOKEN}@pypi.fiftyone.ai fiftyone-teams-app==${TEAMS_APP_VERSION}; \
    fi

#
# Configure shared storage
#

ENV FIFTYONE_MEDIA_CACHE_SIZE_BYTES=-1 \
    FIFTYONE_MEDIA_CACHE_APP_IMAGES=false \
    FIFTYONE_DATABASE_ADMIN=true \
    FIFTYONE_DEFAULT_APP_PORT=6161 \
    FIFTYONE_DATABASE_NAME=alpine

#
# Serve the app
#

CMD hypercorn fiftyone.teams.app:app --bind 0.0.0.0:"${FIFTYONE_DEFAULT_APP_PORT:-5151}"
